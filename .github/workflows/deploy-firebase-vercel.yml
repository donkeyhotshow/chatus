name: Deploy Firebase & Vercel
on: 
  push:
    branches:  ["main"]
  workflow_dispatch: 

jobs:
  prepr: 
    name: prepr-checks
    runs-on: ubuntu-latest
    outputs:
      overall_status: ${{ steps.report.outputs.overall_status }}
    steps:
      - name:  Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js 20
        uses: actions/setup-node@v6
        with: 
          node-version: 20

      - name: Ensure scripts executable
        run: chmod +x scripts/*. sh || true

      - name:  Run prepr checks
        id:  run
        run: bash scripts/prepr-checks.sh

      - name: Upload prepr-report
        if: always()
        uses: actions/upload-artifact@v6
        with: 
          name: prepr-report
          path: prepr-report.json

      - name: Read report
        id: report
        if: always()
        run: |
          if [ -f prepr-report.json ]; then
            jq -r '.overall_status' prepr-report. json > overall.txt || echo "FAIL" > overall.txt
            echo ":: set-output name=overall_status::$(cat overall.txt)"
          else
            echo "::set-output name=overall_status:: FAIL"
          fi

  deploy:
    name: Deploy Firebase & Vercel
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 20
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install dependencies and CLIs
        run: |
          npm ci --legacy-peer-deps
          npm install -g firebase-tools vercel

      - name:  Write Firebase service account
        run:  |
          if [ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > "${{ github.workspace }}/firebase-sa.json"
            chmod 600 "${{ github.workspace }}/firebase-sa.json"
          fi

      - name:  "Firebase:  deploy backend"
        env:
          FIREBASE_TOKEN: ${{ secrets. FIREBASE_TOKEN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          if [ -n "$FIREBASE_TOKEN" ]; then
            echo "Deploying Firebase backend to project $FIREBASE_PROJECT_ID"
            firebase deploy --only firestore: rules,storage:rules,functions --project "$FIREBASE_PROJECT_ID" --token "$FIREBASE_TOKEN"
          else
            echo "Skipping Firebase deploy - FIREBASE_TOKEN not set"
          fi

      - name: "Vercel: deploy"
        env: 
          VERCEL_TOKEN:  ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -n "$VERCEL_TOKEN" ]; then
            echo "Triggering Vercel deploy (project:  $VERCEL_PROJECT_ID)"
            vercel --prod --token "$VERCEL_TOKEN" --confirm
          else
            echo "Skipping Vercel deploy - VERCEL_TOKEN not set"
          fi

      - name:  Smoke tests
        run: |
          echo "Checking frontend health..."
          curl -I -m 10 https://chatus-mu.vercel.app || true
