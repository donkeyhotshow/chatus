name: prepr-checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  prepr-checks:
    name: Run pre-PR checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Ensure scripts executable
        run: chmod +x scripts/*.sh || true

      - name: Run prepr checks
        id: prepr_check
        continue-on-error: true
        run: |
          chmod +x ./scripts/prepr-checks.sh
          ./scripts/prepr-checks.sh --allow-missing-secrets

      - name: Upload prepr-report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: prepr-report
          path: prepr-report.json

      - name: Check PREPR report
        if: github.ref == 'refs/heads/main'
        run: |
          if [ -f prepr-report.json ]; then
            if grep -q '"overall": "FAIL"' prepr-report.json; then
              echo "PREPR checks failed on main branch"
              exit 1
            fi
          fi

