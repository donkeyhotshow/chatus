<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –§–∏–∑–∏—á–µ—Å–∫–∞—è –ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∞</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
    color: #333;
}
.container {
    max-width: 900px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}
h1 {
    text-align: center;
    color: #667eea;
    margin-bottom: 20px;
}
.controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}
.controls input {
    padding: 8px 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}
.controls button {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    background: #667eea;
    color: white;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}
.controls button:hover {
    background: #5568d3;
}
.controls button:active {
    transform: scale(0.98);
}
.controls button.add-btn {
    background: #28a745;
}
.controls button.add-btn:hover {
    background: #218838;
}
#game {
    border: 3px solid #667eea;
    border-radius: 8px;
    display: block;
    margin: 0 auto;
    background: #f0f0f0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.status {
    text-align: center;
    margin: 15px 0;
    padding: 10px;
    background: #e9ecef;
    border-radius: 6px;
    font-weight: 500;
}
.status.connected {
    background: #d4edda;
    color: #155724;
}
.status.disconnected {
    background: #f8d7da;
    color: #721c24;
}
#chat {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}
#messages {
    flex: 1;
    height: 120px;
    overflow-y: auto;
    border: 2px solid #ddd;
    border-radius: 6px;
    padding: 10px;
    background: #f8f9fa;
    font-size: 13px;
}
#messages div {
    margin-bottom: 5px;
    padding: 4px;
    border-radius: 4px;
}
#messages div.system {
    color: #6c757d;
    font-style: italic;
}
#input {
    flex: 1;
    padding: 8px 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}
#send {
    padding: 8px 20px;
    border: none;
    border-radius: 6px;
    background: #667eea;
    color: white;
    cursor: pointer;
    font-size: 14px;
}
#send:hover {
    background: #5568d3;
}
.success-message {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #28a745;
    color: white;
    padding: 30px 50px;
    border-radius: 12px;
    font-size: 24px;
    font-weight: bold;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 1000;
    animation: popIn 0.5s;
    display: none;
}
@keyframes popIn {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}
</style>
</head>
<body>
<div class="container">
    <h1>üéÆ –ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –§–∏–∑–∏—á–µ—Å–∫–∞—è –ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∞</h1>
    
    <div class="controls">
        <input id="room" type="text" placeholder="–ö–æ–º–Ω–∞—Ç–∞" value="room1">
        <input id="name" type="text" placeholder="–í–∞—à–µ –∏–º—è" value="player1">
        <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button id="addBox" class="add-btn">‚ûï –ö–æ—Ä–æ–±–∫–∞</button>
        <button id="addCircle" class="add-btn">‚≠ï –ö—Ä—É–≥</button>
        <button id="addLever" class="add-btn">‚öñÔ∏è –†—ã—á–∞–≥</button>
        <button id="resetLevel">üîÑ –°–±—Ä–æ—Å —É—Ä–æ–≤–Ω—è</button>
    </div>
    
    <div id="status" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
    
    <canvas id="game" width="800" height="600"></canvas>
    
    <div id="chat">
        <div id="messages"></div>
        <input id="input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendChat()">
        <button id="send" onclick="sendChat()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<div id="successMessage" class="success-message">
    üéâ –¶–µ–ø–æ—á–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞! –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!
</div>

<script>
const canvas = document.getElementById('game');
const engine = Matter.Engine.create();
const world = engine.world;
const render = Matter.Render.create({
    canvas: canvas,
    engine: engine,
    options: {
        width: 800,
        height: 600,
        wireframes: false,
        background: '#f0f0f0',
        showAngleIndicator: true
    }
});

Matter.Engine.run(engine);
Matter.Render.run(render);

let ws = null;
let playerName = '';
let roomName = '';
const objects = new Map();
let currentDragId = null;
let ballId = null;
let targetButton = null;
let levelInitialized = false;
let reconnectTimer = null;
const messageQueue = [];

// –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
const ground = Matter.Bodies.rectangle(400, 590, 810, 20, {
    isStatic: true,
    render: { fillStyle: '#8b4513' }
});
Matter.World.add(world, ground);

// –õ–µ–≤–∞—è —Å—Ç–µ–Ω–∞
const leftWall = Matter.Bodies.rectangle(5, 300, 10, 600, {
    isStatic: true,
    render: { fillStyle: '#8b4513' }
});
Matter.World.add(world, leftWall);

// –ü—Ä–∞–≤–∞—è —Å—Ç–µ–Ω–∞
const rightWall = Matter.Bodies.rectangle(795, 300, 10, 600, {
    isStatic: true,
    render: { fillStyle: '#8b4513' }
});
Matter.World.add(world, rightWall);

// –¶–µ–ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ (–æ—Ä–∞–Ω–∂–µ–≤–∞—è)
targetButton = Matter.Bodies.circle(720, 550, 25, {
    isStatic: true,
    label: 'targetButton',
    render: { fillStyle: '#f97316', strokeStyle: '#ea580c', lineWidth: 3 }
});
Matter.World.add(world, targetButton);

// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–Ω–æ–ø–∫–∏
const buttonIndicator = Matter.Bodies.rectangle(720, 520, 60, 10, {
    isStatic: true,
    render: { fillStyle: '#f97316' }
});
Matter.World.add(world, buttonIndicator);

function addMessage(msg, isSystem = false) {
    const m = document.getElementById('messages');
    const div = document.createElement('div');
    div.textContent = msg;
    if (isSystem) div.className = 'system';
    m.appendChild(div);
    m.scrollTop = m.scrollHeight;
}

function updateStatus(connected) {
    const status = document.getElementById('status');
    if (connected) {
        status.textContent = `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ "${roomName}" –∫–∞–∫ "${playerName}"`;
        status.className = 'status connected';
    } else {
        status.textContent = '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ';
        status.className = 'status disconnected';
    }
}

// –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
function safeSend(data) {
    if (ws && ws.readyState === WebSocket.OPEN) {
        try {
            ws.send(JSON.stringify(data));
        } catch (error) {
            console.error('Send error:', error);
            messageQueue.push(data);
        }
    } else {
        messageQueue.push(data);
    }
}

// WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
function connectWS() {
    if (ws) {
        ws.close();
    }
    
    if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
    }
    
    ws = new WebSocket(`ws://localhost:8000/ws/${roomName}/${playerName}`);
    
    ws.onopen = () => {
        updateStatus(true);
        addMessage(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ "${roomName}"`, true);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏
        while (messageQueue.length > 0 && ws.readyState === WebSocket.OPEN) {
            const msg = messageQueue.shift();
            try {
                ws.send(JSON.stringify(msg));
            } catch (error) {
                messageQueue.unshift(msg);
                break;
            }
        }
    };
    
    ws.onclose = () => {
        updateStatus(false);
        addMessage('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', true);
        
        // –ë–∞–∑–æ–≤–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        if (reconnectTimer) clearTimeout(reconnectTimer);
        reconnectTimer = setTimeout(() => {
            addMessage('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', true);
            connectWS();
        }, 1000);
    };
    
    ws.onerror = (error) => {
        addMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', true);
        console.error('WebSocket error:', error);
    };
    
    ws.onmessage = (e) => {
        try {
            const msg = JSON.parse(e.data);
            
            if (msg.type === 'init') {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞
                msg.objects.forEach(o => {
                    spawnObject(o, true);
                });
                msg.chat.forEach(c => {
                    addMessage(`${c.player}: ${c.message}`);
                });
            } else if (msg.type === 'spawn') {
                spawnObject(msg, true);
            } else if (msg.type === 'update') {
                updateObject(msg, true);
            } else if (msg.type === 'remove') {
                removeObject(msg, true);
            } else if (msg.type === 'chat') {
                addMessage(`${msg.player}: ${msg.message}`);
            } else if (msg.type === 'player_joined') {
                addMessage(`üëã ${msg.player} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`, true);
            } else if (msg.type === 'player_left') {
                addMessage(`üëã ${msg.player} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`, true);
            }
        } catch (error) {
            console.error('Error parsing message:', error);
        }
    };
}

document.getElementById('connectBtn').onclick = () => {
    roomName = document.getElementById('room').value.trim() || 'room1';
    playerName = document.getElementById('name').value.trim() || 'player1';
    if (!levelInitialized) {
        initLevel();
    }
    connectWS();
};

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞
function registerObject(id, type, body) {
    objects.set(id, { type, body });
    body.plugin = { id };
}

// –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
function spawnObject(data, isRemote = false) {
    const {
        id = crypto.randomUUID(),
        type,
        x = 400,
        y = 300,
        w = 60,
        h = 60,
        r = 20,
        length = 100
    } = data;
    
    let body;
    
    if (type === 'box') {
        body = Matter.Bodies.rectangle(x, y, w, h, {
            restitution: 0.3,
            friction: 0.2,
            render: { fillStyle: '#4a90e2', strokeStyle: '#2c5aa0', lineWidth: 2 }
        });
    } else if (type === 'circle') {
        body = Matter.Bodies.circle(x, y, r, {
            restitution: 0.3,
            friction: 0.2,
            render: { fillStyle: '#e74c3c', strokeStyle: '#c0392b', lineWidth: 2 }
        });
    } else if (type === 'ball') {
        body = Matter.Bodies.circle(x, y, r, {
            restitution: 0.6,
            friction: 0.1,
            density: 0.001,
            render: { fillStyle: '#f39c12', strokeStyle: '#d68910', lineWidth: 2 }
        });
        ballId = id;
    } else if (type === 'lever') {
        body = Matter.Bodies.rectangle(x, y, length, 20, {
            restitution: 0.2,
            density: 0.002,
            render: { fillStyle: '#9b59b6', strokeStyle: '#7d3c98', lineWidth: 2 }
        });
        const pivot = Matter.Constraint.create({
            pointA: { x, y },
            bodyB: body,
            pointB: { x: 0, y: 0 },
            stiffness: 1,
            render: { strokeStyle: '#7d3c98', lineWidth: 2 }
        });
        Matter.World.add(world, pivot);
    } else if (type === 'platform') {
        body = Matter.Bodies.rectangle(x, y, w, h, {
            isStatic: true,
            render: { fillStyle: '#95a5a6', strokeStyle: '#7f8c8d', lineWidth: 2 }
        });
    }
    
    if (body) {
        Matter.World.add(world, body);
        registerObject(id, type, body);
        
        if (!isRemote) {
            safeSend({
                type: 'spawn',
                id,
                type,
                x,
                y,
                w,
                h,
                r,
                length
            });
        }
    }
}

// –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
const interpolationFactor = 0.3; // –°–∫–æ—Ä–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ (0-1)

function updateObject(data, isRemote = false) {
    const obj = objects.get(data.id);
    if (obj && isRemote) {
        const targetX = data.x;
        const targetY = data.y;
        const currentX = obj.body.position.x;
        const currentY = obj.body.position.y;
        
        // –ü–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –≤–º–µ—Å—Ç–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —Å–∫–∞—á–∫–∞
        const newX = currentX * (1 - interpolationFactor) + targetX * interpolationFactor;
        const newY = currentY * (1 - interpolationFactor) + targetY * interpolationFactor;
        
        Matter.Body.setPosition(obj.body, { x: newX, y: newY });
        
        if (data.angle !== undefined) {
            const currentAngle = obj.body.angle;
            const targetAngle = data.angle;
            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —É–≥–ª–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞
            let angleDiff = targetAngle - currentAngle;
            if (angleDiff > Math.PI) angleDiff -= 2 * Math.PI;
            if (angleDiff < -Math.PI) angleDiff += 2 * Math.PI;
            const newAngle = currentAngle + angleDiff * interpolationFactor;
            Matter.Body.setAngle(obj.body, newAngle);
        }
    }
}

function removeObject(data, isRemote = false) {
    const obj = objects.get(data.id);
    if (obj) {
        Matter.World.remove(world, obj.body);
        objects.delete(data.id);
        if (data.id === ballId) {
            ballId = null;
        }
    }
}

// –ö–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
document.getElementById('addBox').onclick = () => {
    spawnObject({
        type: 'box',
        x: Math.random() * 700 + 50,
        y: 50,
        w: 60,
        h: 60
    });
};

document.getElementById('addCircle').onclick = () => {
    spawnObject({
        type: 'circle',
        x: Math.random() * 700 + 50,
        y: 50,
        r: 20
    });
};

document.getElementById('addLever').onclick = () => {
    spawnObject({
        type: 'lever',
        x: Math.random() * 700 + 50,
        y: Math.random() * 300 + 100,
        length: 100
    });
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è
function initLevel() {
    if (levelInitialized) return;
    
    // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—ä–µ–∫—Ç—ã (–∫—Ä–æ–º–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö)
    objects.forEach((obj, id) => {
        if (obj.type !== 'platform') {
            Matter.World.remove(world, obj.body);
            objects.delete(id);
        }
    });
    
    // –°—Ç–∞—Ä—Ç–æ–≤—ã–π —à–∞—Ä
    spawnObject({
        type: 'ball',
        x: 100,
        y: 100,
        r: 25
    }, false);
    
    // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ü–µ–ø–æ—á–∫–∏
    spawnObject({
        type: 'platform',
        x: 250,
        y: 400,
        w: 120,
        h: 15
    }, false);
    
    spawnObject({
        type: 'platform',
        x: 450,
        y: 350,
        w: 120,
        h: 15
    }, false);
    
    spawnObject({
        type: 'platform',
        x: 600,
        y: 450,
        w: 100,
        h: 15
    }, false);
    
    // –†—ã—á–∞–≥ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞
    spawnObject({
        type: 'lever',
        x: 680,
        y: 500,
        length: 80
    }, false);
    
    levelInitialized = true;
    addMessage('üéÆ –£—Ä–æ–≤–µ–Ω—å –∑–∞–≥—Ä—É–∂–µ–Ω! –ü–æ—Å—Ç—Ä–æ–π—Ç–µ —Ü–µ–ø–æ—á–∫—É, —á—Ç–æ–±—ã —à–∞—Ä –ø–æ–ø–∞–ª –Ω–∞ –æ—Ä–∞–Ω–∂–µ–≤—É—é –∫–Ω–æ–ø–∫—É!', true);
}

document.getElementById('resetLevel').onclick = () => {
    levelInitialized = false;
    initLevel();
    if (ws && ws.readyState === WebSocket.OPEN) {
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –æ —Å–±—Ä–æ—Å–µ
        objects.forEach((obj, id) => {
            if (obj.type !== 'platform' && obj.type !== 'ball') {
                safeSend({ type: 'remove', id });
            }
        });
    }
};

// Drag & Drop
const mouse = Matter.Mouse.create(canvas);
const mouseConstraint = Matter.MouseConstraint.create(engine, {
    mouse: mouse,
    constraint: {
        stiffness: 0.2,
        render: { visible: false }
    }
});
Matter.World.add(world, mouseConstraint);

Matter.Events.on(mouseConstraint, 'startdrag', (e) => {
    currentDragId = e.body.plugin?.id;
});

Matter.Events.on(mouseConstraint, 'enddrag', () => {
    currentDragId = null;
});

// Throttle –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
function throttle(fn, ms) {
    let last = 0;
    return (...args) => {
        const now = Date.now();
        if (now - last > ms) {
            last = now;
            fn(...args);
        }
    };
}

const sendUpdateThrottled = throttle((obj, id) => {
    safeSend({
        type: 'update',
        id,
        x: obj.position.x,
        y: obj.position.y,
        angle: obj.angle
    });
}, 50);

Matter.Events.on(engine, 'afterUpdate', () => {
    if (currentDragId) {
        const obj = objects.get(currentDragId);
        if (obj) {
            sendUpdateThrottled(obj.body, currentDragId);
        }
    }
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É
let buttonPressed = false;
Matter.Events.on(engine, 'collisionStart', (event) => {
    event.pairs.forEach(pair => {
        if ((pair.bodyA === targetButton || pair.bodyB === targetButton) && !buttonPressed) {
            buttonPressed = true;
            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            addMessage('üéâ –¶–µ–ø–æ—á–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞! –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!', true);
            
            setTimeout(() => {
                successMsg.style.display = 'none';
                buttonPressed = false;
            }, 3000);
        }
    });
});

// –ß–∞—Ç
function sendChat() {
    const input = document.getElementById('input');
    const msg = input.value.trim();
    if (msg) {
        safeSend({ type: 'chat', message: msg });
        input.value = '';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', () => {
    initLevel();
});
</script>
</body>
</html>

